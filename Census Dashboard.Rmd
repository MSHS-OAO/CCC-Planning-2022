---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r Install and load packages}
# Code for creating summary of MSH, MSM, and MSW census analysis -----------------
#Install and load necessary packages --------------------
# install.packages("readxl")
# install.packages("writexl")
# install.packages("ggplot2")
# install.packages("lubridate")
# install.packages("dplyr")
# install.packages("reshape2")
# install.packages("svDialogs")
# install.packages("stringr")
# install.packages("formattable")
# install.packages("kableExtra")
# install.packages("ggpubr")
# install.packages("zipcodeR")
# install.packages("tidyr")
#Analysis for weekend discharge tracking
library(readxl)
library(writexl)
library(ggplot2)
library(lubridate)
library(dplyr)
library(reshape2)
library(svDialogs)
library(stringr)
library(formattable)
library(scales)
library(ggpubr)
library(reshape2)
library(knitr)
library(kableExtra)
library(rmarkdown)
library(zipcodeR)
library(tidyr)
library(purrr)
library(janitor)
library(DT)
```


```{r Set directory, import reference and census data, include = FALSE}
# Clear history
rm(list = ls())

## Determine path for working directory --------------
if ("Presidents" %in% list.files("J://")) {
  user_directory <- paste0("J:/Presidents/HSPI-PM/",
                           "Operations Analytics and Optimization/Projects/",
                           "System Operations/CCC Strike Planning")
} else {
  user_directory <- paste0("J:/deans/Presidents/HSPI-PM/",
                           "Operations Analytics and Optimization/Projects/",
                           "System Operations/CCC Strike Planning")
}

## Import data ---------
### Census data
raw_df <- read_excel(path = paste0(user_directory,
                                   "/Data/Command Center Raw Data for Kate Revised with ADT IP Patient 10.21.22.xlsx"))

### Dept mapping
dept_mapping <- read_excel(path = paste0(user_directory,
                                         "/Data",
                                         "/Census Dept and Admit Mappings 2022-10-25.xlsx"),
                           sheet = "Census Dept")

dept_mapping_crosswalk <- dept_mapping %>%
  select(-Notes, -`ARZ Notes`)

admit_type_mapping <- read_excel(path = paste0(user_directory,
                                         "/Data",
                                         "/Census Dept and Admit Mappings 2022-10-25.xlsx"),
                           sheet = "Admit Type")

census_date_start <- as.Date("3/1/21", format = "%m/%d/%y")
census_date_end <- as.Date("5/31/21", format = "%m/%d/%y")

dates_df <- data.frame("CensusDate" = seq.Date(from = census_date_start,
                                               to = census_date_end,
                                               by = "day"))

dates_df <- dates_df %>%
  mutate(DOW = wday(CensusDate, label = TRUE, abbr = TRUE),
         WkendWkday = ifelse(DOW %in% c("Sat", "Sun"), "Weekend",
                             "Weekday"))

total_days <- nrow(dates_df)

dow_summary <- dates_df %>%
  group_by(DOW) %>%
  summarize(Count = n()) %>%
  ungroup()

wkend_wkday_summary <- dates_df %>%
  group_by(WkendWkday) %>%
  summarize(Count = n()) %>%
  ungroup()

unit_type_order <- c("ICU",
                     "Med Surg",
                     "Tele",
                     "ED IP Boarder",
                     "L&D",
                     "Mother Baby",
                     "NICU",
                     "Peds",
                     "Peds ICU",
                     "Rehab",
                     "Psych",
                     "Psych ED")

site_order <- c("MSH", "MSM", "MSW")

wkday_wkend_order <- c("Weekday", "Weekend")
```

```{r Process census data and calculate ADC by various stratifications}
census_range_df <- raw_df %>%
  rename(Encounter = `External Enc Id`,
         AdmitDate = `Admit Date`,
         DischDate = `Dsch Date`,
         CensusDate = `Census Date`,
         CensusDept = `Census Dept`,
         DischSite = `Ip Site`) %>%
  mutate(AdmitDate = as.Date(AdmitDate),
         DischDate = as.Date(DischDate),
         CensusDate = as.Date(CensusDate),
         CensusDay = ifelse(CensusDate == DischDate, 0, 1),
         DOW = wday(CensusDate, label = TRUE, abbr = TRUE),
         DOWNum = wday(CensusDate, label = FALSE),
         WkendWkday = ifelse(DOW %in% c("Sat", "Sun"), "Weekend", 
                             "Weekday")) %>%
  filter(between(CensusDate, census_date_start, census_date_end))

census_range_df <- left_join(census_range_df,
                             dept_mapping_crosswalk,
                             by = c("CensusDept" = "Dept"))

census_range_df <- left_join(census_range_df,
                             admit_type_mapping,
                             by = c("Admission Type" = "AdmissionType"))

census_range_df <- census_range_df %>%
  rename(CensusSite = Site,
         UnitType = `Unit Type`) %>%
  filter(Include %in% "Yes") %>%
  mutate(UnitType = factor(UnitType,
                           levels = unit_type_order,
                           ordered = TRUE),
         CensusSite = factor(CensusSite,
                             levels = site_order,
                             ordered = TRUE),
         WkendWkday = factor(WkendWkday,
                             levels = wkday_wkend_order,
                             ordered = TRUE)) %>%
  arrange(CensusSite, UnitType, DOWNum)

dept_summary_epic <- census_range_df %>%
  filter(CensusSite %in% c("MSM", "MSW")) %>%
  group_by(CensusSite, CensusDept) %>%
  summarize(Census = sum(CensusDay, na.rm = TRUE))

## ADC across all days -----------------
unit_type_total_adc <- census_range_df %>%
  group_by(CensusSite,
           UnitType) %>%
  summarize(CensusDays = sum(CensusDay, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(ADC = CensusDays / total_days)

unit_type_total_adc_table <- unit_type_total_adc %>%
  select(-CensusDays) %>%
  pivot_wider(names_from = CensusSite,
              values_from = ADC) %>%
  adorn_totals(where = "row",
               fill = "-",
               na.rm = TRUE)

## ADC by weekend/weekdays ----------------------
unit_type_wkendwkday_adc <- census_range_df %>%
  group_by(CensusSite,
           UnitType,
           WkendWkday) %>%
  summarize(CensusDays = sum(CensusDay, na.rm = TRUE)) %>%
  ungroup()

unit_type_wkendwkday_adc <- left_join(unit_type_wkendwkday_adc,
                                      wkend_wkday_summary,
                                      by = c("WkendWkday" = "WkendWkday"))

unit_type_wkendwkday_adc <- unit_type_wkendwkday_adc %>%
  mutate(ADC = CensusDays / Count)

unit_type_wkendwkday_adc_table <- unit_type_wkendwkday_adc %>%
  select(-CensusDays, -Count) %>%
  pivot_wider(names_from = c(CensusSite, WkendWkday),
              names_sep = "_",
              values_from = ADC) %>%
  adorn_totals(where = "row",
               fill = "-",
               na.rm = TRUE)



## ADC by day of week ---------------------
unit_type_dow_adc <- census_range_df %>%
  group_by(CensusSite,
           UnitType,
           DOW) %>%
  summarize(CensusDays = sum(CensusDay, na.rm = TRUE)) %>%
  ungroup()

unit_type_dow_adc <- left_join(unit_type_dow_adc,
                               dow_summary,
                               by = c("DOW" = "DOW"))  

unit_type_dow_adc <- unit_type_dow_adc %>%
  mutate(ADC = CensusDays / Count)

unit_type_dow_adc_table <- unit_type_dow_adc %>%
  select(-CensusDays, -Count) %>%
  pivot_wider(names_from = c(CensusSite, DOW),
              names_sep = "_",
              values_from = ADC) %>%
  adorn_totals(where = "row",
               fill = "-",
               na.rm = TRUE)



```

```{r ALOS for each site and unit type}
## Encounter level summary
enc_unit_type_los <- census_range_df %>%
  group_by(Encounter, CensusSite, UnitType) %>%
  summarize(CensusDays = sum(CensusDay, na.rm = TRUE)) %>%
  ungroup()

enc_los_summary <- enc_unit_type_los %>%
  group_by(CensusSite, UnitType) %>%
  summarize(TotalDays = sum(CensusDays, na.rm = TRUE),
            NumEncounters = n()) %>%
  ungroup() %>%
  mutate(UnitType = factor(UnitType,
                           levels = unit_type_order,
                           ordered = TRUE),
         CensusSite = factor(CensusSite,
                             levels = site_order,
                             ordered = TRUE),
         ALOS = TotalDays / NumEncounters) %>%
  arrange(CensusSite, UnitType)

unit_type_los_summary <- enc_los_summary %>%
  select(-TotalDays, -NumEncounters) %>%
  pivot_wider(names_from = CensusSite,
              values_from = ALOS)

```

## MSHS Census Analysis

### Average Daily Census Breakdowns (Created on `r format(Sys.Date(), "%m/%d/%Y")`) {.tabset}

#### ADC Summary
```{r Total ADC kables}
unit_type_total_adc_table <- unit_type_total_adc_table %>%
  rename(`Unit Type` = UnitType) %>%
  pivot_longer(cols = matches("MS[A-Z]{1}"),
               names_to = "Site") %>%
  mutate(Metric = "ADC")

unit_type_los_summary <- unit_type_los_summary %>%
  rename(`Unit Type` = UnitType) %>%
  pivot_longer(cols = matches("MS[A-Z]{1}"),
                names_to = "Site") %>%
  mutate(Metric = "ALOS")


unit_type_adc_los_table <- rbind(unit_type_total_adc_table,
                                 unit_type_los_summary)

unit_type_adc_los_table <- unit_type_adc_los_table %>%
  mutate(`Unit Type` = factor(`Unit Type`,
                              levels = c(unit_type_order, "Total"),
                              ordered = TRUE),
         Site = factor(Site,
                       levels = site_order,
                       ordered = TRUE)) %>%
  arrange(Site, Metric, `Unit Type`) %>%
  pivot_wider(names_from = c(Site, Metric),
              names_sep = " ",
              values_from = value)

kable(unit_type_adc_los_table,
      format = "html",
      escape = FALSE,
      align = "l",
      digits = 1,
      caption = paste("Average Daily Census by Unit Type"),
      col.names = c("Unit Type", "ADC", "ALOS", "ADC", "ALOS", "ADC", "ALOS")) %>%
  kable_styling(bootstrap_options = "hover",
                font_size = 11,
                full_width = FALSE) %>%
  column_spec(c(2:3),
              background = "#ccf1ff") %>%
  column_spec(c(4:5),
              background = "#fccfec") %>%
  column_spec(c(6:7),
              background = "#d8d7f4") %>%
  # row_spec(row = 0,
  #          background = "#221f72",
  #          color = "white") %>%
  row_spec(row = nrow(unit_type_adc_los_table),
           bold = TRUE,
           italic = TRUE,
           background = "#e5e5e6") %>%
  column_spec(c(1, 3, 5, 7), border_right = TRUE) %>%
  add_header_above(c(" " = 1, "MSH" = 2, "MSM" = 2, "MSW" = 2),
                   background = c("", "#00AEEF", "#D80B8C", "#221F72"),
                   line = TRUE,
                   color = "white")




```

#### ADC by Weekend/Weekday
```{r ADC by weekday and weekend kables}
unit_type_wkendwkday_adc_table <- unit_type_wkendwkday_adc_table %>%
  rename(`Unit Type` = UnitType) %>%
  rename_with(~str_replace(.x, "_", "\\ "), contains("_"))

kable(unit_type_wkendwkday_adc_table,
      format = "html",
      escape = FALSE,
      align = "l",
      digits = 1,
      caption = paste("Average Daily Census on Weekdays and Weekends"),
      col.names = c("Unit Type", "Weekday", "Weekend", "Weekday", "Weekend", "Weekday", "Weekend")) %>%
  kable_styling(bootstrap_options = "hover",
                font_size = 11,
                full_width = FALSE) %>%
  column_spec(c(2:3),
              background = "#ccf1ff") %>%
  column_spec(c(4:5),
              background = "#fccfec") %>%
  column_spec(c(6:7),
              background = "#d8d7f4") %>%
  # row_spec(row = 0,
  #          background = "#221f72",
  #          color = "white") %>%
  row_spec(row = nrow(unit_type_wkendwkday_adc_table),
           bold = TRUE,
           italic = TRUE,
           background = "#e5e5e6") %>%
  column_spec(c(1, 3, 5, 7), border_right = TRUE) %>%
  add_header_above(c(" " = 1, "MSH" = 2, "MSM" = 2, "MSW" = 2),
                   background = c("", "#00AEEF", "#D80B8C", "#221F72"),
                   line = TRUE,
                   color = "white")



```

#### ADC by Day of Week
```{r ADC by day of week kables}

site_adc_dow <- function(site) {
  subset_data <- unit_type_dow_adc_table %>%
    select(UnitType, contains(site)) %>%
    mutate(
      across(where(is.numeric), ~replace_na(.x, 0))
      ) %>%
    rename(`Unit Type` = UnitType) %>%
    rename_with(~str_replace(.x, paste0(site, "_"), ""), contains("_"))
  
  kable(subset_data,
        format = "html",
        escape = FALSE,
        align = "l",
        digits = 1,
        caption = paste(site,
                        "Average Daily Census by Day of Week")) %>%
    kable_styling(bootstrap_options = "hover",
                  font_size = 11,
                  full_width = FALSE) %>%
    row_spec(row = 0,
             background = "#221f72",
             color = "white") %>%
    row_spec(row = nrow(subset_data), 
             bold = TRUE,
             italic = TRUE,
             background = "#e5e5e6") %>%
    column_spec(c(1, 8), border_right = TRUE)

}

site_adc_dow(site = "MSH")

site_adc_dow(site = "MSM")

site_adc_dow(site = "MSW")




```



```{r Census Scenarios by Admit Type}
scenarios <- c(.75, .5, .1, .05)
names(scenarios) <- paste0("Scenario",
                           which(scenarios == scenarios),
                           "_",
                           100 * scenarios,
                           "Percent_Elective")

scenarios_df <- as.data.frame(t(scenarios))

unit_type_admit_type_adc <- census_range_df %>%
  group_by(CensusSite,
           UnitType,
           WkendWkday,
           ElectiveNonElective) %>%
  summarize(CensusDays = sum(CensusDay, na.rm = TRUE)) %>%
  ungroup()

unit_type_admit_type_adc <- left_join(unit_type_admit_type_adc,
                                  wkend_wkday_summary,
                                  by = c("WkendWkday" = "WkendWkday"))

unit_type_admit_type_adc <- unit_type_admit_type_adc %>%
  pivot_wider(names_from = ElectiveNonElective,
              values_from = CensusDays) %>%
  rowwise() %>%
  mutate(Total = sum(Elective, `Non-Elective`, na.rm = TRUE),
         Elective_ADC = Elective / Count,
         NonElective_ADC = `Non-Elective` / Count, 
         Total_ADC = Total / Count,
         Elective_Percent = percent(Elective / Total),
         NonElective_Percent = percent(`Non-Elective` / Total)) %>%
  relocate(Elective_ADC, .after = NonElective_ADC) %>%
  relocate(Elective_Percent, .after = NonElective_Percent)

census_scenarios <- cbind(unit_type_admit_type_adc,
                          scenarios_df)

census_scenarios <- census_scenarios %>%
  mutate(across(contains("Scenario"),
                function(x) {
                  x * .$Elective_ADC
                  },
                .names = "{.col}_ADC"
                )) %>%
  # rowwise() %>%
  mutate(across(matches("^(Scenario).*(ADC)$"),
                function(x) {
                  replace_na(x, 0) + .$NonElective_ADC
                },
                .names = "{.col}_Total")
  ) %>%
    select(-matches("^(Scenario).*(Elective)$")) %>%
    rename_with(.fn = ~ str_replace(.x, "Elective_ADC_Total", "Total_ADC"),
                .cols = matches("^(Scenario).*(_Total)$")) %>%
    select(-Count,
           -Elective, -`Non-Elective`, -Total) %>%
    select(colnames(.[!str_detect(colnames(.), "^(Scenario).*(ADC)")]),
           sort(colnames(.[str_detect(colnames(.), "^(Scenario).*(ADC)$")]))) %>%
    relocate(WkendWkday, .after = CensusSite) %>%
    arrange(CensusSite, WkendWkday, UnitType)


census_scenario_kable <- function(site, wkend_wkday) {
  
  subset_census_scenarios <- census_scenarios %>%
    filter(CensusSite %in% site &
             WkendWkday %in% wkend_wkday) %>%
    select(-CensusSite, -WkendWkday) %>%
    adorn_totals(where = "row")
  
  clean_headers = rep(2, length(scenarios))
  
  names(clean_headers) <- paste(
    gsub("(Scenario)([0-9]+)", "\\1 \\2:", 
         str_replace(
           str_replace_all(names(scenarios), "_", " "),
           "Percent", "%")),
    "Admissions")
  
  kable(subset_census_scenarios,
        format = "html",
        escape = FALSE,
        align = "l",
        digits = 1,
        caption = paste(site, wkend_wkday, "ADC Scenarios"),
        col.names = c("Unit Type",
                      "Non-Elective ADC", "Elective ADC", "Total ADC",
                      "Non-Elective %", "Elective %",
                      rep(c("Elective ADC", "Total ADC"),
                          length(scenarios))))%>%
    kable_styling(bootstrap_options = "hover",
                  font_size = 11,
                  full_width = FALSE) %>%
    column_spec(c(2:6),
                background = "#f2f2f3") %>%
    column_spec(c(7:9),
                background = "#ccf1ff") %>%
    column_spec(c(9:10),
                background = "#fccfec") %>%
    column_spec(c(11:12),
                background = "#d8d7f4") %>%
    column_spec(c(13:14),
                background = "#e5e5e6") %>%
    # row_spec(row = 0,
    #          background = "#221f72",
    #          color = "white") %>%
    row_spec(row = nrow(subset_census_scenarios),
             bold = TRUE,
             italic = TRUE) %>% #,
    # background = "#e5e5e6") %>%
    column_spec(c(1, 4, 6, 8, 10, 12), border_right = TRUE) %>%
    add_header_above(c(" " = 1,
                       "Baseline ADC" = 5,
                       clean_headers),
                     background = c("", "#CBCCCD", "#00AEEF", "#D80B8C",
                                    "#221F72", "#58595B"),
                     line = TRUE,
                     color = c("black",
                               "white",
                               "white",
                               "white",
                               "white",
                               "white"))
  
}





```

#### Census Scenarios
```{r Census Scenarios by Admission Type}
census_scenario_kable("MSH", "Weekday")

census_scenario_kable("MSH", "Weekend")

census_scenario_kable("MSM", "Weekday")

census_scenario_kable("MSM", "Weekend")

census_scenario_kable("MSW", "Weekday")

census_scenario_kable("MSW", "Weekend")


```

#### Methodology and Reference Tables

**Data Source and Methodology**

* Based on Epic Census Data provided by Enterprise Reporting Team on 10/21/22
* Data includes inpatients discharged between 3/1/21 and 5/31/21
* Census analysis represents census between 3/1/21 and 5/31/21
* Analysis excludes any census days in departments that are not included (see Department Mappings below)
* Discharge days are not included as census days

**ALOS Methodology**

* LOS for each encounter broken out by total days in each unit type.
* For example, if a patient has a total LOS of 10 days and spends 3 days in an ICU then 7 days in Med Surg, the patient would have an ICU LOS of 3 and Med Surg LOS of 7.
* ALOS by unit type calculated as (Sum of Census Days in Unit Type) / (Number of Encounters with LOS > 0 in that Unit Type)

**Census Scenario Methodology**

* Distinction between elective and non-elective admission based on Admission Type (see Admit Type Mappings below).
* All non-elective volume assumed to remain constant for census scenarios and only elective admission volume changes

---

**Department Mapping Table**

```{r Department Mappings}
excluded_unit_types <- unique(dept_mapping_crosswalk$`Unit Type`)

excluded_unit_types <- excluded_unit_types[!(excluded_unit_types %in% unit_type_order)]

all_unit_types <- c(unit_type_order, excluded_unit_types)

dept_mapping_table <- dept_mapping_crosswalk %>%
  mutate(Site = factor(Site, levels = site_order, ordered = TRUE),
         `Unit Type` = factor(`Unit Type`, levels = all_unit_types,
                              
                              ordered = TRUE)) %>%
  relocate(`Unit Type`, .after = Site) %>%
  arrange(Site, `Unit Type`, desc(Include))

datatable(dept_mapping_table,
          rownames = FALSE,
          options = list(
            pageLength = 15,
            paging = TRUE
          )
          )

```

---

**Admit Type Mapping Table**

```{r Admit Source Mappings}
admit_type_table <- admit_type_mapping %>%
  rename("Admission Type" = AdmissionType,
         "Elective or Non-Elective" = ElectiveNonElective)

datatable(admit_type_table,
          rownames = FALSE,
          options = list(
            pageLength = 20,
            paging = TRUE
          )
          )

```
