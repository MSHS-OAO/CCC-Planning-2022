---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r Install and load packages}
# Code for creating summary of MSH, MSM, and MSW census analysis -----------------
#Install and load necessary packages --------------------
# install.packages("readxl")
# install.packages("writexl")
# install.packages("ggplot2")
# install.packages("lubridate")
# install.packages("dplyr")
# install.packages("reshape2")
# install.packages("svDialogs")
# install.packages("stringr")
# install.packages("formattable")
# install.packages("kableExtra")
# install.packages("ggpubr")
# install.packages("zipcodeR")
# install.packages("tidyr")
#Analysis for weekend discharge tracking
library(readxl)
library(writexl)
library(ggplot2)
library(lubridate)
library(dplyr)
library(reshape2)
library(svDialogs)
library(stringr)
library(formattable)
library(scales)
library(ggpubr)
library(reshape2)
library(knitr)
library(kableExtra)
library(rmarkdown)
library(zipcodeR)
library(tidyr)
library(purrr)
library(janitor)
library(DT)
```


```{r Set directory, import reference and census data, include = FALSE}
# Clear history
rm(list = ls())

## Determine path for working directory --------------
if ("Presidents" %in% list.files("J://")) {
  user_directory <- paste0("J:/Presidents/HSPI-PM/",
                           "Operations Analytics and Optimization/Projects/",
                           "System Operations/CCC Strike Planning")
} else {
  user_directory <- paste0("J:/deans/Presidents/HSPI-PM/",
                           "Operations Analytics and Optimization/Projects/",
                           "System Operations/CCC Strike Planning")
}

## Import data ---------
### Census data
strike_sites_21_df <- read_excel(path = paste0(
  user_directory,
  "/Data",
  "/Strike Sites 032021 to 052021 Census 2022-10-21.xlsx"))

receive_sites_21_df <- read_excel(path = paste0(
  user_directory,
  "/Data",
  "/Receiving Sites 032021 to 052021 Census 2022-11-08.xlsx"))

all_sites_22_df <- read_excel(path = paste0(
  user_directory,
  "/Data",
  "/MSHS 032022 to 052022 Census 2022-11-08.xlsx"))

### Dept mapping
dept_mapping <- read_excel(path = paste0(
  user_directory,
  "/Data",
  "/Census Dept and Admit Mappings 2022-11-09.xlsx"),
  sheet = "MSHS Census Dept")

dept_mapping_crosswalk <- dept_mapping %>%
  select(-Notes, -`ARZ Notes`)

### Admission type mapping file
admit_type_mapping <- read_excel(path = paste0(
  user_directory,
  "/Data",
  "/Census Dept and Admit Mappings 2022-11-09.xlsx"),
  sheet = "Admit Type")


### Dates of interest for this analysis
census_date_start_21 <- as.Date("3/1/21", format = "%m/%d/%y")
census_date_end_21 <- as.Date("5/31/21", format = "%m/%d/%y")

census_date_start_22 <- as.Date("3/1/22", format = "%m/%d/%y")
census_date_end_22 <- as.Date("5/31/22", format = "%m/%d/%y")

dates_21 <- data.frame("CensusDate" = seq.Date(from = census_date_start_21,
                                               to = census_date_end_21,
                                               by = "day"))

dates_22 <- data.frame("CensusDate" = seq.Date(from = census_date_start_22,
                                               to = census_date_end_22,
                                               by = "day"))

### Determine total days, weekdays/weekends, etc. in the date range of interest
dates_21 <- dates_21 %>%
  mutate(DOW = wday(CensusDate, label = TRUE, abbr = TRUE),
         WkendWkday = ifelse(DOW %in% c("Sat", "Sun"), "Weekend",
                             "Weekday"))

dates_22 <- dates_22 %>%
  mutate(DOW = wday(CensusDate, label = TRUE, abbr = TRUE),
         WkendWkday = ifelse(DOW %in% c("Sat", "Sun"), "Weekend",
                             "Weekday"))

total_days_21 <- nrow(dates_21)
total_days_22 <- nrow(dates_22)

dow_summary_21 <- dates_21 %>%
  group_by(DOW) %>%
  summarize(Count = n()) %>%
  ungroup()

dow_summary_22 <- dates_22 %>%
  group_by(DOW) %>%
  summarize(Count = n()) %>%
  ungroup()

wkend_wkday_summary_21 <- dates_21 %>%
  group_by(WkendWkday) %>%
  summarize(Count = n()) %>%
  ungroup()

wkend_wkday_summary_22 <- dates_22 %>%
  group_by(WkendWkday) %>%
  summarize(Count = n()) %>%
  ungroup()


### Specify hierarchy of units included in analysis for consistent visualizations
unit_type_order <- c("ICU",
                     "Med Surg",
                     "Tele",
                     "ED IP Boarder",
                     "L&D",
                     "Mother Baby",
                     "Mother Baby - Nursery",
                     "NICU",
                     "Peds",
                     "Peds ICU",
                     "Rehab",
                     "Psych",
                     "Psych ED",
                     "Detox",
                     "TBD")

### Specify heirarchy of sites included in analysis for consistent visualizations
strike_sites_order <- c("MSH", "MSM", "MSW")
receiving_sites_order <- c("MSB", "MSBI", "MSQ")
all_sites_order <- c(strike_sites_order, receiving_sites_order)

wkday_wkend_order <- c("Weekday", "Weekend")
```

```{r Process census data and calculate ADC by various stratifications}
# Clean up column names and order
receive_sites_21_df <- receive_sites_21_df %>%
  rename(Encounter = `External Enc Id`,
         AdmitDate = `Month, Day, Year of Admit Date`,
         DischDate = `Month, Day, Year of Dsch Date`,
         CensusDate = `Month, Day, Year of Census Date`,
         CensusDept = `Census Dept`,
         DischSite = `Ip Site`) %>%
  # Format columns and determine days of week
  mutate(AdmitDate = as.Date(AdmitDate),
         DischDate = as.Date(DischDate),
         CensusDate = as.Date(CensusDate),
         CensusDay = ifelse(CensusDate == DischDate, 0, 1),
         DOW = wday(CensusDate, label = TRUE, abbr = TRUE),
         DOWNum = wday(CensusDate, label = FALSE),
         WkendWkday = ifelse(DOW %in% c("Sat", "Sun"), "Weekend", 
                             "Weekday")) %>%
  # Filter on appropriate date range
  filter(between(CensusDate, census_date_start_21, census_date_end_21))
  

### Primary census data processing
strike_sites_21_df <- strike_sites_21_df %>%
  # Rename columns from raw data for easier analysis
  rename(Encounter = `External Enc Id`,
         AdmitDate = `Admit Date`,
         DischDate = `Dsch Date`,
         CensusDate = `Census Date`,
         CensusDept = `Census Dept`,
         DischSite = `Ip Site`) %>%
  # Format columns and determine days of week
  mutate(AdmitDate = as.Date(AdmitDate),
         DischDate = as.Date(DischDate),
         CensusDate = as.Date(CensusDate),
         CensusDay = ifelse(CensusDate == DischDate, 0, 1),
         DOW = wday(CensusDate, label = TRUE, abbr = TRUE),
         DOWNum = wday(CensusDate, label = FALSE),
         WkendWkday = ifelse(DOW %in% c("Sat", "Sun"), "Weekend", 
                             "Weekday")) %>%
  # Filter on appropriate date range
  filter(between(CensusDate, census_date_start_21, census_date_end_21))

receive_sites_21_df <- receive_sites_21_df[colnames(strike_sites_21_df)]

## Combine census data for strike sites and receiving sites
census_range_21_df <- rbind(strike_sites_21_df,
                            receive_sites_21_df)

### Crosswalk with department mapping
census_range_21_df <- left_join(census_range_21_df,
                                dept_mapping_crosswalk,
                                by = c("CensusDept" = "Dept"))

### Crosswalk with admission type mapping
census_range_21_df <- left_join(census_range_21_df,
                                admit_type_mapping,
                                by = c("Admission Type" = "AdmissionType"))

### Filter out excluded departments/unit types
census_range_21_df <- census_range_21_df %>%
  rename(CensusSite = Site,
         UnitType = `Unit Type`) %>%
  filter(Include %in% "Yes") %>%
  # Sort data based on defined hierarchy
  mutate(UnitType = factor(UnitType,
                           levels = unit_type_order,
                           ordered = TRUE),
         CensusSite = factor(CensusSite,
                             levels = all_sites_order,
                             ordered = TRUE),
         WkendWkday = factor(WkendWkday,
                             levels = wkday_wkend_order,
                             ordered = TRUE)) %>%
  arrange(CensusSite, UnitType, DOWNum)

## ADC across all days for 2021 -----------------
unit_type_total_adc_21 <- census_range_21_df %>%
  group_by(CensusSite,
           UnitType) %>%
  summarize(CensusDays = sum(CensusDay, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(ADC = CensusDays / total_days_21)

unit_type_total_adc_table_21 <- unit_type_total_adc_21 %>%
  select(-CensusDays) %>%
  pivot_wider(names_from = CensusSite,
              values_from = ADC) %>%
  adorn_totals(where = "row",
               fill = "-",
               na.rm = TRUE)

## ADC by weekend/weekdays ----------------------
unit_type_wkendwkday_adc_21 <- census_range_21_df %>%
  group_by(CensusSite,
           UnitType,
           WkendWkday) %>%
  summarize(CensusDays = sum(CensusDay, na.rm = TRUE)) %>%
  ungroup()

unit_type_wkendwkday_adc_21 <- left_join(unit_type_wkendwkday_adc_21,
                                         wkend_wkday_summary_21,
                                         by = c("WkendWkday" = "WkendWkday"))

unit_type_wkendwkday_adc_21 <- unit_type_wkendwkday_adc_21 %>%
  mutate(ADC = CensusDays / Count)

unit_type_wkendwkday_adc_table_21 <- unit_type_wkendwkday_adc_21 %>%
  select(-CensusDays, -Count) %>%
  pivot_wider(names_from = c(CensusSite, WkendWkday),
              names_sep = "_",
              values_from = ADC) %>%
  adorn_totals(where = "row",
               fill = "-",
               na.rm = TRUE)

```

```{r ALOS for each site and unit type}
## Encounter level summary

### Summarize each encounter's LOS in each unit type
enc_unit_type_los_21 <- census_range_21_df %>%
  group_by(Encounter, CensusSite, UnitType) %>%
  summarize(CensusDays = sum(CensusDay, na.rm = TRUE)) %>%
  ungroup()

### Calculate ALOS in each unit type based on total census days and unique encounters
enc_los_summary_21 <- enc_unit_type_los_21 %>%
  group_by(CensusSite, UnitType) %>%
  summarize(TotalDays = sum(CensusDays, na.rm = TRUE),
            NumEncounters = n()) %>%
  ungroup() %>%
  mutate(UnitType = factor(UnitType,
                           levels = unit_type_order,
                           ordered = TRUE),
         CensusSite = factor(CensusSite,
                             levels = all_sites_order,
                             ordered = TRUE),
         ALOS = TotalDays / NumEncounters) %>%
  arrange(CensusSite, UnitType)


### Format for merging with ADC table
unit_type_los_summary_21 <- enc_los_summary_21 %>%
  select(-TotalDays, -NumEncounters) %>%
  pivot_wider(names_from = CensusSite,
              values_from = ALOS)

```

```{r Census calculations for 2022 comparison}
census_range_22_df <- all_sites_22_df %>%
  rename(Encounter = `External Enc Id`,
         AdmitDate = `Month, Day, Year of Admit Date`,
         DischDate = `Month, Day, Year of Dsch Date`,
         CensusDate = `Month, Day, Year of Census Date`,
         CensusDept = `Census Dept`,
         DischSite = `Ip Site`) %>%
  # Format columns and determine days of week
  mutate(AdmitDate = as.Date(AdmitDate),
         DischDate = as.Date(DischDate),
         CensusDate = as.Date(CensusDate),
         CensusDay = ifelse(CensusDate == DischDate, 0, 1),
         DOW = wday(CensusDate, label = TRUE, abbr = TRUE),
         DOWNum = wday(CensusDate, label = FALSE),
         WkendWkday = ifelse(DOW %in% c("Sat", "Sun"), "Weekend", 
                             "Weekday")) %>%
  # Filter on appropriate date range
  filter(between(CensusDate, census_date_start_22, census_date_end_22))

### Crosswalk with department mapping
census_range_22_df <- left_join(census_range_22_df,
                                dept_mapping_crosswalk,
                                by = c("CensusDept" = "Dept"))

### Crosswalk with admission type mapping
census_range_22_df <- left_join(census_range_22_df,
                                admit_type_mapping,
                                by = c("Admission Type" = "AdmissionType"))

### Filter out excluded departments/unit types
census_range_22_df <- census_range_22_df %>%
  rename(CensusSite = Site,
         UnitType = `Unit Type`) %>%
  filter(Include %in% "Yes") %>%
  # Sort data based on defined hierarchy
  mutate(UnitType = factor(UnitType,
                           levels = unit_type_order,
                           ordered = TRUE),
         CensusSite = factor(CensusSite,
                             levels = all_sites_order,
                             ordered = TRUE),
         WkendWkday = factor(WkendWkday,
                             levels = wkday_wkend_order,
                             ordered = TRUE)) %>%
  arrange(CensusSite, UnitType, DOWNum)

## ADC across all days for 2021 -----------------
unit_type_total_adc_22 <- census_range_22_df %>%
  group_by(CensusSite,
           UnitType) %>%
  summarize(CensusDays = sum(CensusDay, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(ADC = CensusDays / total_days_22)

unit_type_total_adc_table_22 <- unit_type_total_adc_22 %>%
  select(-CensusDays) %>%
  pivot_wider(names_from = CensusSite,
              values_from = ADC) %>%
  adorn_totals(where = "row",
               fill = "-",
               na.rm = TRUE)

## ADC by weekend/weekdays ----------------------
unit_type_wkendwkday_adc_22 <- census_range_22_df %>%
  group_by(CensusSite,
           UnitType,
           WkendWkday) %>%
  summarize(CensusDays = sum(CensusDay, na.rm = TRUE)) %>%
  ungroup()

unit_type_wkendwkday_adc_22 <- left_join(unit_type_wkendwkday_adc_22,
                                         wkend_wkday_summary_22,
                                         by = c("WkendWkday" = "WkendWkday"))

unit_type_wkendwkday_adc_22 <- unit_type_wkendwkday_adc_22 %>%
  mutate(ADC = CensusDays / Count)

unit_type_wkendwkday_adc_table_22 <- unit_type_wkendwkday_adc_22 %>%
  select(-CensusDays, -Count) %>%
  pivot_wider(names_from = c(CensusSite, WkendWkday),
              names_sep = "_",
              values_from = ADC) %>%
  adorn_totals(where = "row",
               fill = "-",
               na.rm = TRUE)

```
```{r Create dataframes comparing 2021 to 2022 census}
total_adc_21 <- unit_type_total_adc_table_21 %>%
  pivot_longer(cols = starts_with("MS"),
               names_to = "Site",
               values_to = "ADC") %>%
  mutate(Year = 2021)

total_adc_22 <- unit_type_total_adc_table_22 %>%
  pivot_longer(cols = starts_with("MS"),
               names_to = "Site",
               values_to = "ADC") %>%
  mutate(Year = 2022)

total_adc_compare <- rbind(total_adc_21, total_adc_22)

total_adc_compare <- total_adc_compare %>%
  pivot_wider(names_from = Year,
              values_from = ADC) %>%
  mutate(ADCChange = `2022` - `2021`) %>%
  pivot_longer(cols = c(`2021`, `2022`, ADCChange),
               names_to = "Period",
               values_to = "ADC") %>%
  mutate(UnitType = factor(UnitType, levels = c(unit_type_order, "Total"),
                           ordered = TRUE),
         Site = factor(Site, levels = all_sites_order, ordered = TRUE)) %>%
  arrange(Site, Period, UnitType)

strike_sites_total_compare <- total_adc_compare %>%
  filter(Site %in% strike_sites_order) %>%
  pivot_wider(names_from = c(Site, Period),
              names_sep = "_",
              values_from = ADC) %>%
  filter(., rowSums(is.na(.)) != ncol(.) - 1) %>%
  mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>%
  rename(`Unit Type` = UnitType) #%>%
  # rename_with(~str_replace(.x, "_", "\\ "), contains("_")) %>%
  # rename_with(~str_replace(.x, "ADCChange", "ADC Change"), contains("ADCChange"))

receiving_sites_total_compare <- total_adc_compare %>%
  filter(Site %in% receiving_sites_order) %>%
  pivot_wider(names_from = c(Site, Period),
              names_sep = "_",
              values_from = ADC) %>%
  filter(., rowSums(is.na(.)) != ncol(.) - 1) %>%
  mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>%
  rename(`Unit Type` = UnitType) #%>%
  # rename_with(~str_replace(.x, "_", "\\ "), contains("_")) %>%
  # rename_with(~str_replace(.x, "ADCChange", "ADC Change"), contains("ADCChange"))


```

## MSHS Census Analysis

### Average Daily Census Breakdowns (Created on `r format(Sys.Date(), "%m/%d/%Y")`) {.tabset}

#### ADC Summary
```{r Total ADC kable visualizations}

### Format ADC table for easier merging with ALOS
unit_type_total_adc_table_21 <- unit_type_total_adc_table_21 %>%
  mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>%
  rename(`Unit Type` = UnitType) %>%
  pivot_longer(cols = matches("MS[A-Z]+"),
               names_to = "Site") %>%
  mutate(Metric = "ADC")

unit_type_los_summary_21 <- unit_type_los_summary_21 %>%
  rename(`Unit Type` = UnitType) %>%
  pivot_longer(cols = matches("MS[A-Z]{1}"),
                names_to = "Site") %>%
  mutate(Metric = "ALOS")

### Combine ADC and ALOS tables
unit_type_adc_los_table_21 <- rbind(unit_type_total_adc_table_21,
                                    unit_type_los_summary_21)

### Arrange and reformat ADC and ALOS table
unit_type_adc_los_table_21 <- unit_type_adc_los_table_21 %>%
  mutate(`Unit Type` = factor(`Unit Type`,
                              levels = c(unit_type_order, "Total"),
                              ordered = TRUE),
         Site = factor(Site,
                       levels = all_sites_order,
                       ordered = TRUE)) %>%
  arrange(Site, Metric, `Unit Type`) %>%
  pivot_wider(names_from = c(Site, Metric),
              names_sep = " ",
              values_from = value)

### Create table for visualizing ADC and ALOS at each site
kable(unit_type_adc_los_table_21,
      format = "html",
      escape = FALSE,
      align = "c",
      digits = 1,
      caption = paste0("Average Daily Census by Unit Type",
                      " (",
                      format(min(census_range_21_df$CensusDate),
                             "%m/%d/%y"),
                      "-",
                      format(max(census_range_21_df$CensusDate),
                             "%m/%d/%y"),
                      ")")) %>%
  kable_styling(bootstrap_options = "hover",
                font_size = 11,
                full_width = FALSE) %>%
  column_spec(c(2:(1 + (ncol(unit_type_adc_los_table_21) - 1) / 2)),
              background = "#ccf1ff") %>%
  column_spec(c(((1 + (ncol(unit_type_adc_los_table_21) - 1) / 2) + 1):ncol(unit_type_adc_los_table_21)),
              background = "#fccfec") %>%
  # column_spec(c(2:3, 8:9),
  #             background = "#ccf1ff") %>%
  # column_spec(c(4:5, 10:11),
  #             background = "#fccfec") %>%
  # column_spec(c(6:7, 12:13),
  #             background = "#d8d7f4") %>%
  # row_spec(row = 0,
  #          background = "#221f72",
  #          color = "white") %>%
  row_spec(row = nrow(unit_type_adc_los_table_21),
           bold = TRUE,
           italic = TRUE,
           background = "#e5e5e6") %>%
  # add_header_above(c(" " = 1, "MSH" = 2, "MSM" = 2, "MSW" = 2,
  #                    "MSB" = 2, "MSBI" = 2, "MSQ" = 2),
  #                  background = c("", "#00AEEF", "#00AEEF", "#00AEEF",
  #                                 "#D80B8C", "#D80B8C", "#D80B8C"),
  #                  line = TRUE,
  #                  color = "white") %>%
  add_header_above(c(" " = 1,
                     "Potential Strike Sites" = 6,
                     "Receiving Sites" = 6),
                   background = c("", "#00AEEF", "#D80B8C"),
                   line = TRUE,
                   color = "white") %>%
  column_spec(seq(1, ncol(unit_type_adc_los_table_21), 2), border_right = TRUE)

```

#### ADC by Weekend/Weekday
```{r ADC by weekday and weekend kable visualizations}

### Clean up formatting for weekday vs. weekend ADC table
unit_type_wkendwkday_adc_table_21 <- unit_type_wkendwkday_adc_table_21 %>%
  mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>%
  rename(`Unit Type` = UnitType) %>%
  rename_with(~str_replace(.x, "_", "\\ "), contains("_"))

### Create table for visualizing weekday vs. weekend ADC
kable(unit_type_wkendwkday_adc_table_21,
      format = "html",
      escape = FALSE,
      align = "c",
      digits = 1,
      caption = paste0("Average Daily Census on Weekdays and Weekends",
                       " (",
                       format(min(census_range_21_df$CensusDate),
                              "%m/%d/%y"),
                       "-",
                       format(max(census_range_21_df$CensusDate),
                              "%m/%d/%y"),
                       ")")) %>%
      # col.names = c("Unit Type",
      #               rep(c("Weekday", "Weekend"), 6))) %>%
  kable_styling(bootstrap_options = "hover",
                font_size = 11,
                full_width = FALSE) %>%
  column_spec(c(2:(1 + (ncol(unit_type_wkendwkday_adc_table_21) - 1) / 2)),
              background = "#ccf1ff") %>%
  column_spec(c(((1 + (ncol(unit_type_wkendwkday_adc_table_21) - 1) / 2) + 1):
                  ncol(unit_type_wkendwkday_adc_table_21)),
              background = "#fccfec") %>%
  # column_spec(c(2:3),
  #             background = "#ccf1ff") %>%
  # column_spec(c(4:5),
  #             background = "#fccfec") %>%
  # column_spec(c(6:7),
  #             background = "#d8d7f4") %>%
  # row_spec(row = 0,
  #          background = "#221f72",
  #          color = "white") %>%
  row_spec(row = nrow(unit_type_wkendwkday_adc_table_21),
           bold = TRUE,
           italic = TRUE,
           background = "#e5e5e6") %>%
  row_spec(row = 0,
           hline_after = FALSE) %>%
  column_spec(seq(1, ncol(unit_type_wkendwkday_adc_table_21), 2),
              border_right = TRUE) %>%
  # add_header_above(c(" " = 1, "MSH" = 2, "MSM" = 2, "MSW" = 2,
  #                    "MSB" = 2, "MSBI" = 2, "MSQ" = 2),
  #                  background = c("", "#00AEEF", "#00AEEF", "#00AEEF",
  #                                 "#D80B8C", "#D80B8C", "#D80B8C"),
  #                  line = TRUE,
  #                  color = "white") %>%
  add_header_above(c(" " = 1,
                     "Potential Strike Sites" = 6,
                     "Receiving Sites" = 6),
                   background = c("", "#00AEEF", "#D80B8C"),
                   line = TRUE,
                   color = "white")



```


```{r Census Scenarios by Admit Type}

### Census scenarios
scenarios <- c(.75, .5, .1, .05)
names(scenarios) <- paste0("Scenario",
                           which(scenarios == scenarios),
                           "_",
                           100 * scenarios,
                           "Percent_Elective")

scenarios_df <- as.data.frame(t(scenarios))

### Census by elective vs. non-elective admissions
unit_type_admit_type_adc_21 <- census_range_21_df %>%
  group_by(CensusSite,
           UnitType,
           WkendWkday,
           ElectiveNonElective) %>%
  summarize(CensusDays = sum(CensusDay, na.rm = TRUE)) %>%
  ungroup()

### Crosswalk with number of weekdays/weekends in date range
unit_type_admit_type_adc_21 <- left_join(unit_type_admit_type_adc_21,
                                      wkend_wkday_summary_21,
                                      by = c("WkendWkday" = "WkendWkday"))

### Calculate ADC by admission type
unit_type_admit_type_adc_21 <- unit_type_admit_type_adc_21 %>%
  pivot_wider(names_from = ElectiveNonElective,
              values_from = CensusDays) %>%
  rowwise() %>%
  mutate(Total = sum(Elective, `Non-Elective`, na.rm = TRUE),
         Elective_ADC = Elective / Count,
         NonElective_ADC = `Non-Elective` / Count, 
         Total_ADC = Total / Count,
         across(where(is.numeric), ~replace_na(.x, 0)),
         Elective_Percent = percent(Elective / Total),
         NonElective_Percent = percent(`Non-Elective` / Total)) %>%
  relocate(Elective_ADC, .after = NonElective_ADC) %>%
  relocate(Elective_Percent, .after = NonElective_Percent)

### Combine ADC with scenarios
census_scenarios_21 <- cbind(unit_type_admit_type_adc_21,
                          scenarios_df)

### Determine ADC for various scenarios
census_scenarios_21 <- census_scenarios_21 %>%
  mutate(across(contains("Scenario"),
                # Multiply Elective ADC by census scenario scale factor
                function(x) {
                  x * .$Elective_ADC
                  },
                .names = "{.col}_ADC"
                )) %>%
  # rowwise() %>%
  mutate(across(matches("^(Scenario).*(ADC)$"),
                # Determine new total ADC assuming Non-Elective ADC remains the same
                function(x) {
                  replace_na(x, 0) + .$NonElective_ADC
                },
                .names = "{.col}_Total")
         ) %>%
  # Select, rename, and relocate columns
  select(-matches("^(Scenario).*(Elective)$")) %>%
  rename_with(.fn = ~ str_replace(.x, "Elective_ADC_Total", "Total_ADC"),
              .cols = matches("^(Scenario).*(_Total)$")) %>%
  select(-Count,
         -Elective, -`Non-Elective`, -Total) %>%
  select(colnames(.[!str_detect(colnames(.), "^(Scenario).*(ADC)")]),
         sort(colnames(.[str_detect(colnames(.), "^(Scenario).*(ADC)$")]))) %>%
  relocate(WkendWkday, .after = CensusSite) %>%
  arrange(CensusSite, WkendWkday, UnitType)


## Custom function for creating census scenario tables for each site and weekday/weekend combination
census_scenario_kable <- function(site, wkend_wkday) {
  
  subset_census_scenarios <- census_scenarios_21 %>%
    filter(CensusSite %in% site &
             WkendWkday %in% wkend_wkday) %>%
    select(-CensusSite, -WkendWkday) %>%
    adorn_totals(where = "row")
  
  clean_headers = rep(2, length(scenarios))
  
  names(clean_headers) <- paste(
    gsub("(Scenario)([0-9]+)", "\\1 \\2:", 
         str_replace(
           str_replace_all(names(scenarios), "_", " "),
           "Percent", "%")),
    "Admissions")
  
  kable(subset_census_scenarios,
        format = "html",
        escape = FALSE,
        align = "l",
        digits = 1,
        caption = paste0(site,
                         " ",
                         wkend_wkday, " ",
                         "ADC Scenarios",
                         " (",
                         format(min(census_range_21_df$CensusDate),
                                "%m/%d/%y"),
                         "-",
                         format(max(census_range_21_df$CensusDate),
                                "%m/%d/%y"),
                         ")"),
        col.names = c("Unit Type",
                      "Non-Elective ADC", "Elective ADC", "Total ADC",
                      "Non-Elective %", "Elective %",
                      rep(c("Elective ADC", "Total ADC"),
                          length(scenarios))))%>%
    kable_styling(bootstrap_options = "hover",
                  font_size = 11,
                  full_width = FALSE) %>%
    column_spec(c(2:6),
                background = "#f2f2f3") %>%
    column_spec(c(7:9),
                background = "#ccf1ff") %>%
    column_spec(c(9:10),
                background = "#fccfec") %>%
    column_spec(c(11:12),
                background = "#d8d7f4") %>%
    column_spec(c(13:14),
                background = "#e5e5e6") %>%
    # row_spec(row = 0,
    #          background = "#221f72",
    #          color = "white") %>%
    row_spec(row = nrow(subset_census_scenarios),
             bold = TRUE,
             italic = TRUE) %>% #,
    # background = "#e5e5e6") %>%
    column_spec(c(1, 4, 6, 8, 10, 12), border_right = TRUE) %>%
    add_header_above(c(" " = 1,
                       "Baseline ADC" = 5,
                       clean_headers),
                     background = c("", "#CBCCCD", "#00AEEF", "#D80B8C",
                                    "#221F72", "#58595B"),
                     line = TRUE,
                     color = c("black",
                               "white",
                               "white",
                               "white",
                               "white",
                               "white"))
  
}


```

#### Census Scenarios {.tabset}

##### MSH
```{r Census Scenarios by Admission Type for MSH}

## Call custom functions to create tables for visualizing census scenarios
census_scenario_kable("MSH", "Weekday")

census_scenario_kable("MSH", "Weekend")

```

##### MSM
```{r Census Scenarios by Admission Type for MSM}

census_scenario_kable("MSM", "Weekday")

census_scenario_kable("MSM", "Weekend")

```

##### MSW
```{r Census scenarios by admission type for MSW}
census_scenario_kable("MSW", "Weekday")

census_scenario_kable("MSW", "Weekend")

```

##### MSB
```{r Census scenarios by admission type for MSB}

census_scenario_kable("MSB", "Weekday")

census_scenario_kable("MSB", "Weekend")

```

##### MSBI
```{r Census scenarios by admission type for MSBI}

census_scenario_kable("MSBI", "Weekday")

census_scenario_kable("MSBI", "Weekend")

```

##### MSQ
```{r Census scenarios by admission type for MSQ}
census_scenario_kable("MSQ", "Weekday")

census_scenario_kable("MSQ", "Weekend")

```

#### 2021 vs. 2022 Census
```{r Compare 2021 and 2022 census}
total_adc_compare_kable <- function(site_type = c("strike", "receiving")) {
  
  sites_incl <- get(paste0(site_type, "_sites_order"))
  
  site_headers <- rep(3, length(sites_incl))
  names(site_headers) <- sites_incl
  
  data <- total_adc_compare %>%
    filter(Site %in% sites_incl) %>%
    pivot_wider(names_from = c(Site, Period),
                names_sep = "_",
                values_from = ADC) %>%
    filter(., rowSums(is.na(.)) != ncol(.) - 1) %>%
    mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>%
    rename(`Unit Type` = UnitType)
  
  kable(data,
        format = "html",
        escape = FALSE,
        align = "c",
        digits = 1,
        caption = paste(str_to_title(site_type),
                        "Sites 2021 and 2022 ADC Comparison",
                        "(3/21-5/21 vs. 3/22-5/22)"),
        col.names = c("Unit Type", rep(c("2021", "2022", "Change (2022-2021)"),
                                       length(sites_incl)))
          ) %>%
    kable_styling(bootstrap_options = "hover",
                  font_size = 11,
                  full_width = FALSE) %>%
    column_spec(c(2:4),
                background = "#ccf1ff") %>%
    column_spec(c(5:7),
                background = "#fccfec") %>%
    column_spec(c(8:10),
                background = "#d8d7f4") %>%
    # row_spec(row = 0,
    #          background = "#221f72",
    #          color = "white") %>%
    row_spec(row = nrow(data),
             bold = TRUE,
             italic = TRUE) %>% #,
    # background = "#e5e5e6") %>%
    column_spec(c(1, 4, 7, 10), border_right = TRUE) %>%
    add_header_above(c(" " = 1,
                       site_headers),
                     background = c("", "#00AEEF", "#D80B8C", "#221F72"),
                     line = TRUE,
                     color = c("black", rep("white", length(sites_incl))))

}

total_adc_compare_kable("strike")

total_adc_compare_kable("receiving")



```

#### Methodology and Reference Tables

**Data Source and Methodology**

* MSH, MSM, MSW 2021 Data: Based on Epic census data provided by Enterprise Reporting Team on 10/21/22
* MSB, MSBI, MSQ 2021 Data and all sites 2022 Data: Based on Epic census data provided by Enterprise Reporting Team on 11/8/22
* Data includes inpatients discharged from 3/1/21-5/31/21 and 3/1/22-5/1/22
* Census analysis represents census days from 3/1/21-5/31/21 and 3/1/22-5/1/22
* Analysis excludes any census days in departments that are not included (see Department Mappings below)
* Discharge days are not included as census days

**ALOS Methodology**

* LOS for each encounter broken out by total days in each unit type.
* For example, if a patient has a total LOS of 10 days and spends 3 days in an ICU then 7 days in Med Surg, the patient would have an ICU LOS of 3 and Med Surg LOS of 7.
* ALOS by unit type calculated as (Sum of Census Days in Unit Type) / (Number of Encounters with LOS > 0 in that Unit Type)

**Census Scenario Methodology**

* Distinction between elective and non-elective admission based on Admission Type (see Admit Type Mappings below).
* All non-elective volume assumed to remain constant for census scenarios and only elective admission volume changes

---

**Department Mapping Table**

```{r Department Mappings}
excluded_unit_types <- unique(dept_mapping_crosswalk$`Unit Type`)

excluded_unit_types <- excluded_unit_types[!(excluded_unit_types %in% unit_type_order)]

all_unit_types <- c(unit_type_order, excluded_unit_types)

dept_mapping_table <- dept_mapping_crosswalk %>%
  mutate(Site = factor(Site, levels = all_sites_order, ordered = TRUE),
         `Unit Type` = factor(`Unit Type`, levels = all_unit_types,
                              
                              ordered = TRUE)) %>%
  relocate(`Unit Type`, .after = Site) %>%
  arrange(Site, `Unit Type`, desc(Include))

datatable(dept_mapping_table,
          rownames = FALSE,
          options = list(
            pageLength = 15,
            paging = TRUE
          ),
          filter = 'top'
          )

```

---

**Admit Type Mapping Table**

```{r Admit Source Mappings}
admit_type_table <- admit_type_mapping %>%
  rename("Admission Type" = AdmissionType,
         "Elective or Non-Elective" = ElectiveNonElective)

datatable(admit_type_table,
          rownames = FALSE,
          options = list(
            pageLength = 20,
            paging = TRUE
          )
          )

```
